## 📆 每日总结

**日期：** 2025-11-04  
**项目：** easycwmp TR-069 功能增强  

---

### ✅ 今日完成

#### 1. 修复 WWC URSP 参数拆分逻辑
- **问题：** `Device.WWC.URSP.1.TrafficDescriptor.1.RouteSelectionDescriptor.1.NetworkSlice.SliceServiceType` 和 `SliceDifferentiator` 参数上报时显示完整的 `01.000000` 值，未正确拆分
- **修复：** 
  - 优化 `nssai` 值拆分逻辑（从 `"01.000000"` 拆分为 `SST="01"` 和 `SD="000000"`）
  - 使用 `memcpy` 替代 `strncpy`，确保字符串正确终止
  - 添加 `$2` 支持（`Device.WWC.URSP.$2`），支持双卡配置
- **文件修改：**
  - `cwmp/trz4/trz4_info.c` - `trz4_info_WWC()` 函数拆分逻辑
  - `cwmp/trz4/trz4.c` - 添加 `$2` 参数定义

#### 2. 实现 Ping 命令服务下发
- **需求：** ACS 通过 `SetParameterValues` 下发 ping 命令，设备执行后返回结果
- **实现功能：**
  - 参数定义：`custom.params.cmd.Ping`, `custom.params.cmd.SerialNum`, `custom.params.cmd.Result`
  - 命令解析：支持 Windows 格式（`-t`）自动转换为 Linux 格式（`-c 4`）
  - 结果解析：成功/失败次数、丢包率、平均响应时间、可达性
  - 结果格式：JSON 格式存储，包含序列号、统计信息、原始输出
  - 执行机制：仅在 SetParameterValues 时执行一次，Inform 上报时只读取结果，不重复执行
- **文件修改：**
  - `cwmp/trz4/trz4.h` - 添加 `trz4_cmd` 结构体
  - `cwmp/trz4/trz4.c` - 添加参数定义
  - `cwmp/trz4/trz4_set.c` - 实现 `custom_params_cmd_set()` 处理函数
  - `cwmp/cwmp.h` - 添加函数声明

#### 3. 实现 Traceroute 命令服务下发
- **需求：** ACS 通过 `SetParameterValues` 下发 traceroute 命令，设备执行后返回结果
- **实现功能：**
  - 参数定义：`custom.params.cmd.Traceroute`, `custom.params.cmd.TracerouteSerialNum`, `custom.params.cmd.TracerouteResult`
  - 命令解析：提取目标 IP，支持自定义参数（`-m`, `-w`, `-q`）
  - 结果解析：逐跳解析（跳数、主机名、IP、响应时间）、总跳数、完成状态
  - 结果格式：JSON 格式，包含每一跳的详细信息数组
  - 执行机制：与 ping 相同，仅在 SetParameterValues 时执行
- **文件修改：**
  - `cwmp/trz4/trz4.h` - 扩展 `trz4_cmd` 结构体
  - `cwmp/trz4/trz4.c` - 添加参数定义（支持嵌套参数名）
  - `cwmp/trz4/trz4_set.c` - 实现 traceroute 处理逻辑

#### 4. 实现 Reboot 命令服务下发（重要）
- **需求：** ACS 通过 `SetParameterValues` 下发 reboot 命令，设备重启后上报结果
- **实现功能：**
  - 参数定义：`custom.params.cmd.Reboot`, `custom.params.cmd.RebootSerialNum`, `custom.params.cmd.RebootTime`, `custom.params.cmd.RebootResult`
  - 持久化存储：使用 `/etc/` 目录保存任务文件和标志文件（重启后仍保留）
  - 延迟执行：在 `apply` 阶段执行，确保 `SetParameterValuesResponse` 已发送
  - 安全机制：收到所有参数后才执行，避免误操作
  - 重启验证：
    - 保存重启前时间戳到 `/etc/.cwmp_reboot_flag`
    - 重启后通过 `/proc/uptime` 计算系统启动时间
    - 判断：系统启动时间 > 标志时间 且 运行时间 > 30秒
  - 结果生成：重启成功且系统稳定后，自动生成结果（包含序列号、状态、计划时间、实际时间）
  - 自动清理：处理完成后删除任务文件和标志文件
- **文件修改：**
  - `cwmp/trz4/trz4.h` - 扩展 `trz4_cmd` 结构体
  - `cwmp/trz4/trz4.c` - 添加参数定义
  - `cwmp/trz4/trz4_set.c` - 实现 reboot 参数设置和任务保存
  - `cwmp/cwmp_func.c` - 在 `cwmpfunc_apply()` 中检查并执行 reboot 任务
  - `cwmp/trz4/trz4_info.c` - 添加 `trz4_info_check_reboot_result()` 函数，在 `tr_info_update()` 中检查重启结果

---

### 🧩 问题与解决

#### 问题 1：WWC 参数拆分失败
- **现象：** `SliceServiceType` 和 `SliceDifferentiator` 仍显示完整的 `01.000000`
- **原因：** 字符串拆分逻辑中使用 `strncpy` 可能未正确处理字符串终止符
- **解决方案：**
  - 改用 `memcpy` 进行精确拷贝
  - 手动添加字符串终止符 `\0`
  - 优化拆分条件判断（`dot_pos > nssai_value`）

#### 问题 2：编译错误 - 重复的 else 块
- **现象：** `trz4_set.c:969:11: error: expected '}' before 'else'`
- **原因：** ping 处理逻辑中有两个 `else` 块（第 945 行和第 969 行）
- **解决方案：** 删除重复的 `else` 块

#### 问题 3：函数声明缺失
- **现象：** `libs_cjson_parameter_value` 等函数隐式声明警告
- **解决方案：** 在 `cwmp/cwmp.h` 中添加函数声明

#### 问题 4：链接错误 - cJSON_AddArrayToObject
- **现象：** `undefined reference to 'cJSON_AddArrayToObject'`
- **原因：** cJSON 库没有 `cJSON_AddArrayToObject()` 函数
- **解决方案：** 使用正确的 API：
  ```c
  cJSON *empty_hops_array = cJSON_CreateArray();
  cJSON_AddItemToObject(traceroute_result, "hop_details", empty_hops_array);
  ```

#### 问题 5：参数名语法错误
- **现象：** `request for member 'SerialNum' in something not a structure or union`
- **原因：** C 中不能使用点号访问结构体成员（`custom.params.cmd.Traceroute.SerialNum`）
- **解决方案：** 
  - 将参数名改为 `TracerouteSerialNum`（无点号）
  - 在处理函数中同时支持两种格式（`Traceroute.SerialNum` 和 `TracerouteSerialNum`）

#### 问题 6：重启后临时文件消失
- **现象：** 重启后 `/tmp/` 目录会被清空，无法判断重启是否成功
- **解决方案：**
  - 将文件保存到 `/etc/` 目录（持久化）
  - 在标志文件中保存重启前的时间戳
  - 通过 `/proc/uptime` 计算系统启动时间，判断重启是否发生
  - 检查系统运行时间是否超过 30 秒，确保系统稳定

---

### 💡 今日收获

1. **TR-069 命令执行机制**
   - SetParameterValues 触发 `set` 回调函数
   - GetParameterValues 和 Inform 只读取结构体值，不触发 `set` 回调
   - 通过这种机制确保命令只执行一次

2. **cJSON API 使用**
   - 没有 `cJSON_AddArrayToObject()`，需要先 `cJSON_CreateArray()` 再 `cJSON_AddItemToObject()`
   - 使用 `cJSON_AddItemToArray()` 将对象添加到数组
   - 使用 `cJSON_PrintUnformatted()` 生成紧凑的 JSON 字符串

3. **系统重启验证技巧**
   - 使用 `/etc/` 目录存储持久化数据（重启后保留）
   - 通过 `/proc/uptime` 获取系统运行时间
   - 通过时间戳比较判断重启是否发生
   - 通过运行时间判断系统是否稳定

4. **命令执行安全性**
   - 延迟执行（`sleep 3 && reboot &`）确保响应已发送
   - 参数完整性检查（所有参数都设置后才执行）
   - 使用文件标志避免重复执行

---

### 🗓️ 明日计划

1. **中信科新增 USIM 上报需求**
   - 卡一卡二进行具体区分
   - 分别上报卡一和卡二的 USIM 相关信息

2. **联通问题设备锁 4G 后平台看不到锁频信息**
   - 调查锁频信息上报逻辑
   - 检查是否缺少相关参数上报
   - 验证锁频命令是否生效

3. **测试今日新增功能**
   - 测试 ping 命令下发和结果上报
   - 测试 traceroute 命令下发和结果上报
   - 测试 reboot 命令下发和重启后结果上报
   - 验证 WWC 参数拆分是否正确

---

### 📝 备注

- 今日新增的命令下发功能（ping/traceroute/reboot）均采用持久化存储和延迟执行机制，确保不会重复执行
- reboot 功能通过系统启动时间和运行时间双重验证，确保重启成功且系统稳定后才上报结果
- 所有命令执行结果均以 JSON 格式存储，便于 ACS 解析

