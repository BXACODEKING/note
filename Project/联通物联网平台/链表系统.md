### ä¸€ã€æ ¸å¿ƒæ•°æ®ç»“æ„
```
typedef struct {
    int conn_flag;                           // è¿æ¥çŠ¶æ€æ ‡å¿—
    int alarm_flag;                          // å‘Šè­¦æ ‡å¿—
    report_ctrl_st report;                   // ä¸ŠæŠ¥æ§åˆ¶å‚æ•°
    int getInfo_flag;                        // è·å–ä¿¡æ¯æ ‡å¿—
    int response;                            // å†™å“åº”
    pthread_mutex_t datalock;                // çº¿ç¨‹äº’æ–¥é”
    
    // â­ å…­ä¸ªæ ¸å¿ƒé“¾è¡¨
    struct list_head report_data_record;     // é“¾è¡¨1: å˜åŒ–ä¸ŠæŠ¥è®°å½•é“¾è¡¨
    struct list_head report_data_rt;         // é“¾è¡¨2: å®æ—¶æ•°æ®ç¼“å­˜é“¾è¡¨
    struct list_head report_data;            // é“¾è¡¨3: å¾…ä¸ŠæŠ¥åŸå§‹æ•°æ®é“¾è¡¨
    struct list_head report_list;            // é“¾è¡¨4: æ‰“åŒ…å¥½çš„å‘¨æœŸä¸ŠæŠ¥æ¶ˆæ¯é“¾è¡¨
    struct list_head report_rt_list;         // é“¾è¡¨5: æ‰“åŒ…å¥½çš„å®æ—¶ä¸ŠæŠ¥æ¶ˆæ¯é“¾è¡¨
    struct list_head alarm_list;             // é“¾è¡¨6: å‘Šè­¦æ¶ˆæ¯é“¾è¡¨
} report_message_st;
```
### äºŒã€é“¾è¡¨èŠ‚ç‚¹ç»“æ„
```
typedef struct {
    unsigned char *payload;      // æŒ‡å‘å®é™…æ•°æ®çš„æŒ‡é’ˆ
    struct list_head list;       // å†…æ ¸é“¾è¡¨èŠ‚ç‚¹ï¼ˆåŒå‘é“¾è¡¨ï¼‰
} report_node_st;
```
å†…å­˜å¸ƒå±€ç¤ºæ„ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ report_node_st  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ payload  â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â†’ æŒ‡å‘ data_format_st æˆ– JSON å­—ç¬¦ä¸²
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ list.prev â—„â”€â”€â”€â”€â”€â”¼â”€â”€â†’ æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹
â”‚ list.next â—„â”€â”€â”€â”€â”€â”¼â”€â”€â†’ æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
### ä¸‰ã€å…­å¤§é“¾è¡¨çš„è¯¦ç»†åº”ç”¨åœºæ™¯

#### ğŸ”´Â é“¾è¡¨1ï¼šreport_data_recordÂ - å˜åŒ–ä¸ŠæŠ¥è®°å½•é“¾è¡¨

ä½¿ç”¨åœºæ™¯ï¼šÂ policy_changeÂ ç­–ç•¥ï¼ˆå˜åŒ–ä¸ŠæŠ¥æ¨¡å¼ï¼‰

ä½œç”¨ï¼šÂ è®°å½•æ¯ä¸ªè®¾å¤‡æ¯ä¸ªå˜é‡çš„æœ€åä¸€æ¬¡ä¸ŠæŠ¥å€¼ï¼Œç”¨äºå¯¹æ¯”æ–°æ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚

ä»£ç ä½ç½®ï¼šÂ mqtt_reportdata.c:200-238Â (publish_type_change())

å·¥ä½œæµç¨‹ï¼š
```
// æ­¥éª¤1: æ–°æ•°æ®åˆ°æ¥
data_format_st *data_pointer;  // ä¾‹å¦‚: device="Sensor01", var="æ¸©åº¦", val="25.5"

// æ­¥éª¤2: éå† report_data_record æŸ¥æ‰¾å†å²è®°å½•
list_for_each_entry_safe(report_node, n, &report_msg->report_data_record, list) {
    ptr = (data_format_st *)report_node->payload;
    
    // æƒ…å†µA: è®¾å¤‡å+å˜é‡å+å€¼éƒ½ç›¸åŒ â†’ æ•°æ®æœªå˜åŒ–
    if (è®¾å¤‡åç›¸åŒ && å˜é‡åç›¸åŒ && å€¼ç›¸åŒ) {
        reflash = 1;  // æ ‡è®°ï¼šä¸éœ€è¦ä¸ŠæŠ¥
        break;
    }
    
    // æƒ…å†µB: è®¾å¤‡å+å˜é‡åç›¸åŒï¼Œä½†å€¼ä¸åŒ â†’ æ•°æ®å˜åŒ–äº†
    if (è®¾å¤‡åç›¸åŒ && å˜é‡åç›¸åŒ) {
        update_to_report_record_list(ptr, data_pointer);  // æ›´æ–°è®°å½•
        reflash = 2;  // æ ‡è®°ï¼šéœ€è¦ä¸ŠæŠ¥
        break;
    }
}

// æ­¥éª¤3: å¤„ç†ç»“æœ
if (reflash == 0) {
    // é¦–æ¬¡å‡ºç°çš„å˜é‡ï¼Œæ·»åŠ åˆ°è®°å½•é“¾è¡¨
    add_to_list(&report_msg->report_data_record, data_pointer, sizeof(...));
}
if (reflash != 1) {
    // å€¼å‘ç”Ÿå˜åŒ–æˆ–é¦–æ¬¡å‡ºç°ï¼ŒåŠ å…¥å¾…ä¸ŠæŠ¥é˜Ÿåˆ—
    add_to_list(&report_msg->report_data, data_pointer, sizeof(...));
}
```
å®é™…ä¾‹å­ï¼š
```
æ—¶åˆ» T1: æ¸©åº¦=25.5 â†’ åŠ å…¥ report_data_record å¹¶ä¸ŠæŠ¥
æ—¶åˆ» T2: æ¸©åº¦=25.5 â†’ å‘ç°å€¼æœªå˜åŒ–ï¼Œä¸ä¸ŠæŠ¥
æ—¶åˆ» T3: æ¸©åº¦=26.0 â†’ å‘ç°å€¼å˜åŒ–ï¼Œæ›´æ–° report_data_record å¹¶ä¸ŠæŠ¥
```
#### ğŸŸ¢Â é“¾è¡¨2ï¼šreport_data_rtÂ -Â å®æ—¶æ•°æ®ç¼“å­˜é“¾è¡¨

ä½¿ç”¨åœºæ™¯ï¼šÂ policy_intervalÂ ç­–ç•¥çš„å®æ—¶æ•°æ®æš‚å­˜

ä½œç”¨ï¼šÂ ç¼“å­˜æœ€æ–°çš„è®¾å¤‡æ•°æ®å€¼ï¼ˆæ¯ä¸ªå˜é‡åªä¿ç•™æœ€æ–°å€¼ï¼‰ï¼Œç”¨äºå®æ—¶æŸ¥è¯¢æˆ–å¿«é€Ÿä¸ŠæŠ¥ã€‚

ä»£ç ä½ç½®ï¼šÂ mqtt_reportdata.c:271-300Â (publish_type_rt())

å·¥ä½œæµç¨‹ï¼š
```
// æ•°æ®å»é‡é€»è¾‘ï¼ˆä¿ç•™æœ€æ–°å€¼ï¼‰
list_for_each_entry_safe(report_node, n, &report_msg->report_data_rt, list) {
    ptr = (data_format_st *)report_node->payload;
    
    // å¦‚æœæ‰¾åˆ°ç›¸åŒçš„è®¾å¤‡å’Œå˜é‡ï¼Œæ›´æ–°å€¼
    if (è®¾å¤‡åç›¸åŒ && å˜é‡åç›¸åŒ) {
        update_to_report_record_list(ptr, data_pointer);  // è¦†ç›–æ—§å€¼
        reflash = false;  // æ ‡è®°ï¼šå·²æ›´æ–°ï¼Œä¸éœ€è¦æ–°å¢
        break;
    }
}

if (reflash) {
    // é¦–æ¬¡å‡ºç°ï¼Œæ–°å¢èŠ‚ç‚¹
    add_to_list(&report_msg->report_data_rt, data_pointer, sizeof(...));
}
```
ä¸Â report_dataÂ çš„åŒºåˆ«ï¼š

- report_dataï¼šç´¯ç§¯æ‰€æœ‰æ•°æ®ï¼Œç”¨äºæ‰¹é‡ä¸ŠæŠ¥

- report_data_rtï¼šåªä¿ç•™æœ€æ–°å€¼ï¼Œç”¨äºå®æ—¶ä¸ŠæŠ¥

å®é™…ä¾‹å­ï¼š
```
æ—¶åˆ» T1: æ¸©åº¦=25.5 â†’ report_data_rt ä¸­æ·»åŠ èŠ‚ç‚¹ {"æ¸©åº¦": "25.5"}
æ—¶åˆ» T2: æ¸©åº¦=26.0 â†’ report_data_rt ä¸­æ›´æ–°èŠ‚ç‚¹ {"æ¸©åº¦": "26.0"} (è¦†ç›–)
æ—¶åˆ» T3: æ¹¿åº¦=60.0 â†’ report_data_rt ä¸­æ·»åŠ èŠ‚ç‚¹ {"æ¹¿åº¦": "60.0"}
```
#### ğŸ”µÂ é“¾è¡¨3ï¼šreport_dataÂ - å¾…ä¸ŠæŠ¥åŸå§‹æ•°æ®é“¾è¡¨

ä½¿ç”¨åœºæ™¯ï¼šÂ æ‰€æœ‰ä¸ŠæŠ¥ç­–ç•¥çš„åŸå§‹æ•°æ®ç¼“å­˜

ä½œç”¨ï¼šÂ å­˜å‚¨æ‰€æœ‰éœ€è¦ä¸ŠæŠ¥çš„åŸå§‹æ•°æ®ï¼ˆdata_format_stÂ ç»“æ„ï¼‰ï¼Œç­‰å¾…æ‰“åŒ…æˆÂ JSONã€‚

æ•°æ®æ¥æºï¼š

1. publish_type_original()Â - åŸå§‹å€¼ä¸ŠæŠ¥æ¨¡å¼ï¼ˆè¡Œ196ï¼‰

2. publish_type_change()Â - å˜åŒ–ä¸ŠæŠ¥æ¨¡å¼ï¼ˆè¡Œ234ï¼‰

3. publish_type_interval()Â - å‘¨æœŸä¸ŠæŠ¥æ¨¡å¼ï¼ˆè¡Œ265ï¼‰

ä»£ç ä½ç½®ï¼šÂ mqtt_reportdata.c:240-268Â (publish_type_interval())

å·¥ä½œæµç¨‹ï¼š
```
// åœºæ™¯: å‘¨æœŸä¸ŠæŠ¥æ¨¡å¼
publish_type_interval(report_msg, data_pointer) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è®¾å¤‡+å˜é‡
    list_for_each_entry_safe(report_node, n, &report_msg->report_data, list) {
        if (è®¾å¤‡åç›¸åŒ && å˜é‡åç›¸åŒ) {
            update_to_report_record_list(ptr, data_pointer);  // æ›´æ–°å€¼
            reflash = false;
            break;
        }
    }
    
    if (reflash) {
        add_to_list(&report_msg->report_data, data_pointer, sizeof(...));
    }
}
```
æ•°æ®æµè½¬ï¼š
```
æ•°æ®åº“å›è°ƒ data_cb()
    â†“
publish_message_prepare()
    â†“
æ ¹æ® policy é€‰æ‹©ç­–ç•¥
    â†“
publish_type_xxx()
    â†“
add_to_list(&report_data, ...)  â† æ•°æ®å­˜å…¥è¿™ä¸ªé“¾è¡¨
    â†“
report_data_subcontract_process()  â† å®šæ—¶æ‰“åŒ…
    â†“
ä» report_data å–å‡ºæ•°æ® â†’ æ‰“åŒ…æˆ JSON â†’ åŠ å…¥ report_list
```
#### ğŸŸ¡Â é“¾è¡¨4ï¼šreport_listÂ - æ‰“åŒ…å¥½çš„å‘¨æœŸä¸ŠæŠ¥æ¶ˆæ¯é“¾è¡¨

ä½¿ç”¨åœºæ™¯ï¼šÂ å­˜å‚¨å·²æ‰“åŒ…æˆÂ JSON æ ¼å¼çš„å‘¨æœŸä¸ŠæŠ¥æ¶ˆæ¯

ä½œç”¨ï¼šÂ ç»è¿‡Â report_data_subcontract_process()Â å¤„ç†åï¼ŒåŸå§‹æ•°æ®è¢«æ‰“åŒ…æˆ JSON å­—ç¬¦ä¸²ï¼Œå­˜å…¥æ­¤é“¾è¡¨ç­‰å¾…å‘é€ã€‚

ä»£ç ä½ç½®ï¼šÂ mqtt_reportdata.c:440-484Â (report_data_subcontract_process())

æ‰“åŒ…æµç¨‹ï¼š
```
report_data_subcontract_process(report_msg) {
    // 1. ä» report_data é“¾è¡¨å–å‡ºæ•°æ®ï¼ˆæœ€å¤š payload_size æ¡ï¼‰
    cnt = 0;
    list_for_each_entry_safe(report_node, n, &report_msg->report_data, list) {
        memcpy(data_read + cnt*MAX_STORE_BUF_LEN, report_node->payload, sizeof(...));
        cnt++;
        
        if (cnt >= report_msg->report.payload_size) {  // è¾¾åˆ°æ‰¹é‡é˜ˆå€¼
            // 2. æ‰“åŒ…æˆ JSON
            report_message_create(report_msg, policy_interval, data_read, cnt);
            cnt = 0;
        }
        
        // 3. åˆ é™¤å·²å¤„ç†çš„èŠ‚ç‚¹
        list_del(&report_node->list);
        systemMemoryFree(report_node);
    }
    
    // 4. å¤„ç†å‰©ä½™æ•°æ®
    report_message_create(report_msg, policy_interval, data_read, cnt);
}
```
report_message_create()Â å†…éƒ¨é€»è¾‘ï¼ˆè¡Œ340-438ï¼‰ï¼š
```
// æ„é€  JSON æ ¼å¼ï¼š
{
  "devs": [
    {
      "device": "Sensor01",
      "timestamp": 1234567890,
      "data": [
        {"key": "æ¸©åº¦", "val": "25.5", "timestamp": 1234567890},
        {"key": "æ¹¿åº¦", "val": "60.0", "timestamp": 1234567890}
      ]
    }
  ]
}

// åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
string = json_serialize_to_string_pretty(root);

// åŠ å…¥ report_list é“¾è¡¨ï¼ˆè¡Œ428ï¼‰
add_to_list(&report_msg->report_list, buffer, strlen(buffer)+1);
```
å‘é€æµç¨‹ï¼ˆè¡Œ593-620ï¼‰ï¼š
```
report_interval_message(report_msg, mosq, mqttserver) {
    pthread_mutex_lock(&report_msg->datalock);
    
    // 1. å…ˆå°†åŸå§‹æ•°æ®æ‰“åŒ…
    report_data_subcontract_process(report_msg);
    
    // 2. éå† report_list å‘é€
    list_for_each_entry_safe(report_node, n, &report_msg->report_list, list) {
        payload = (unsigned char *)report_node->payload;
        
        // 3. è°ƒç”¨ MQTT å‘é€
        mqtt_publish_interval_message(report_msg, mosq, mqttserver, payload);
        
        // 4. å‘é€æˆåŠŸååˆ é™¤èŠ‚ç‚¹
        if (å‘é€æˆåŠŸ) {
            systemMemoryFree(report_node->payload);
            list_del(&report_node->list);
            systemMemoryFree(report_node);
        }
    }
    
    pthread_mutex_unlock(&report_msg->datalock);
}
```
#### ğŸŸ£Â é“¾è¡¨5ï¼šreport_rt_listÂ - æ‰“åŒ…å¥½çš„å®æ—¶ä¸ŠæŠ¥æ¶ˆæ¯é“¾è¡¨

ä½¿ç”¨åœºæ™¯ï¼šÂ å­˜å‚¨å®æ—¶ä¸ŠæŠ¥çš„Â JSON æ¶ˆæ¯ï¼ˆç±»ä¼¼Â report_listï¼Œä½†ç”¨äºå®æ—¶æ•°æ®ï¼‰

ä½œç”¨ï¼šÂ report_data_rtÂ æ‰“åŒ…æˆ JSON åå­˜å…¥æ­¤é“¾è¡¨ã€‚

ä»£ç ä½ç½®ï¼šÂ mqtt_reportdata.c:486-525Â (report_rt_subcontract_process())

å·¥ä½œæµç¨‹ï¼š
```
report_rt_subcontract_process(report_msg) {
    // ä» report_data_rt å–æ•°æ® â†’ æ‰“åŒ… â†’ åŠ å…¥ report_rt_list
    list_for_each_entry_safe(report_node, n, &report_msg->report_data_rt, list) {
        memcpy(data_read + cnt*MAX_STORE_BUF_LEN, report_node->payload, sizeof(...));
        cnt++;
        
        if (cnt >= report_msg->report.payload_size) {
            report_message_create(report_msg, policy_realtime, data_read, cnt);
            // â†‘ mode=policy_realtime ä¼šåŠ å…¥ report_rt_list (è¡Œ430-432)
            cnt = 0;
        }
    }
}
```
å‘é€æµç¨‹ï¼šÂ report_rt_message()Â å‡½æ•°ï¼ˆç±»ä¼¼Â report_interval_message()ï¼‰
#### ğŸ”´Â é“¾è¡¨6ï¼šalarm_listÂ - å‘Šè­¦æ¶ˆæ¯é“¾è¡¨

ä½¿ç”¨åœºæ™¯ï¼šÂ å­˜å‚¨éœ€è¦ç«‹å³ä¸ŠæŠ¥çš„å‘Šè­¦æ•°æ®

ä½œç”¨ï¼šÂ å‘Šè­¦æ•°æ®ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸ç»è¿‡æ‰¹é‡æ‰“åŒ…ï¼Œç›´æ¥å•ç‹¬å‘é€ã€‚

ä»£ç ä½ç½®ï¼šÂ mqtt_reportdata.c:176-185Â (publish_type_alarm())

æ·»åŠ æµç¨‹ï¼š
```
publish_type_alarm(report_msg, data_pointer) {
    // ç›´æ¥åŠ å…¥å‘Šè­¦é“¾è¡¨
    add_to_list(&report_msg->alarm_list, data_pointer, sizeof(data_format_st));
    
    // è®¾ç½®å‘Šè­¦æ ‡å¿—
    report_msg->alarm_flag = 1;
}
```
å‘é€æµç¨‹ï¼ˆè¡Œ562-591ï¼‰ï¼š
```
report_alarm_message(report_msg, mosq, mqttserver) {
    pthread_mutex_lock(&report_msg->datalock);
    
    // éå†å‘Šè­¦é“¾è¡¨
    list_for_each_entry_safe(report_node, n, &report_msg->alarm_list, list) {
        data_pointer = (data_format_st *)report_node->payload;
        
        // å•ç‹¬å‘é€æ¯æ¡å‘Šè­¦ï¼ˆä¸æ‰¹é‡ï¼‰
        mqtt_publish_alarm_message(report_msg, mosq, mqttserver, data_pointer);
        
        if (å‘é€æˆåŠŸ) {
            // åˆ é™¤èŠ‚ç‚¹
            systemMemoryFree(report_node->payload);
            list_del(&report_node->list);
            systemMemoryFree(report_node);
        } else {
            // å‘é€å¤±è´¥ï¼Œä¿ç•™åœ¨é“¾è¡¨ä¸­ï¼Œä¸‹æ¬¡é‡è¯•
            return E_FAIL;
        }
    }
    
    pthread_mutex_unlock(&report_msg->datalock);
}
```
### å››ã€å®Œæ•´æ•°æ®æµè½¬å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®æºï¼šæ•°æ®åº“å›è°ƒ data_cb()                                     â”‚
â”‚  æ¥æ”¶ data_format_st æ•°æ®                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
        åˆ¤æ–­æ•°æ®ç±»å‹ (report_type)
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
     å‘Šè­¦æ•°æ®                 æ™®é€šæ•°æ®
        â”‚                       â”‚
        â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     publish_message_prepare()
â”‚ alarm_list   â”‚              â”‚
â”‚ (é“¾è¡¨6)      â”‚              â†“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     æ ¹æ® policy é€‰æ‹©ç­–ç•¥
        â”‚                     â”‚
        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚           â”‚           â”‚              â”‚
        â”‚   policy_original  policy_change  policy_interval
        â”‚         â”‚           â”‚           â”‚
        â”‚         â†“           â†“           â†“
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”‚report_  â”‚  â”‚report_  â”‚  â”‚report_  â”‚  â”‚report_  â”‚
        â”‚   â”‚data     â”‚  â”‚data_    â”‚  â”‚data     â”‚  â”‚data_rt  â”‚
        â”‚   â”‚(é“¾è¡¨3)  â”‚  â”‚record   â”‚  â”‚(é“¾è¡¨3)  â”‚  â”‚(é“¾è¡¨2)  â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚(é“¾è¡¨1)  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚             â”‚
        â”‚                     â”‚             â”‚             â”‚
        â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
        â”‚                           â”‚                     â”‚
        â”‚                           â†“                     â†“
        â”‚              report_data_subcontract_process()  report_rt_subcontract_process()
        â”‚                           â”‚                     â”‚
        â”‚                           â†“                     â†“
        â”‚                   æ‰“åŒ…æˆ JSON                æ‰“åŒ…æˆ JSON
        â”‚                           â”‚                     â”‚
        â”‚                           â†“                     â†“
        â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚report_  â”‚           â”‚report_  â”‚
        â”‚                    â”‚list     â”‚           â”‚rt_list  â”‚
        â”‚                    â”‚(é“¾è¡¨4)  â”‚           â”‚(é“¾è¡¨5)  â”‚
        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  MQTT å‘é€çº¿ç¨‹            â”‚
                        â”‚  (MQTT_DEVINFO çŠ¶æ€)     â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚ report_alarm_message()   â”‚
                        â”‚ report_interval_message()â”‚
                        â”‚ report_rt_message()      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â†“
                        mosquitto_publish() â†’ äº‘å¹³å°
```
### äº”ã€çº¿ç¨‹å®‰å…¨æœºåˆ¶

æ‰€æœ‰é“¾è¡¨æ“ä½œéƒ½é€šè¿‡Â pthread_mutex_tÂ datalockÂ ä¿æŠ¤ï¼š
```
// æ·»åŠ æ•°æ®æ—¶åŠ é”
publish_message_prepare() {
    pthread_mutex_lock(&report_msg->datalock);
    
    publish_type_interval(report_msg, data_pointer);  // æ“ä½œé“¾è¡¨
    
    pthread_mutex_unlock(&report_msg->datalock);
}

// å‘é€æ•°æ®æ—¶åŠ é”
report_interval_message() {
    pthread_mutex_lock(&report_msg->datalock);
    
    list_for_each_entry_safe(...);  // éå†é“¾è¡¨å‘é€
    
    pthread_mutex_unlock(&report_msg->datalock);
}
```
### å…­ã€æ€§èƒ½ä¼˜åŒ–è®¾è®¡

1. æ‰¹é‡ä¸ŠæŠ¥ï¼špayload_sizeÂ æ§åˆ¶æ¯æ¬¡æ‰“åŒ…æ•°é‡ï¼ˆé»˜è®¤50æ¡ï¼‰ï¼Œå‡å°‘ MQTT æ¶ˆæ¯æ•°é‡

2. å»é‡æœºåˆ¶ï¼šreport_data_rtÂ å’ŒÂ publish_type_interval()Â åªä¿ç•™æœ€æ–°å€¼

3. åˆ†çº§å¤„ç†ï¼šå‘Šè­¦ç«‹å³å‘é€ï¼Œæ™®é€šæ•°æ®æ‰¹é‡å‘é€

4. å†…å­˜ç®¡ç†ï¼šå‘é€æˆåŠŸåç«‹å³é‡Šæ”¾èŠ‚ç‚¹ï¼Œé¿å…å†…å­˜æ³„æ¼

---

### ä¸ƒã€æ€»ç»“å¯¹ç…§è¡¨
| é“¾è¡¨åç§°               | å­˜å‚¨å†…å®¹         | æ•°æ®ç±»å‹           | ä½œç”¨         | å¤„ç†å‡½æ•°                      |
| ------------------ | ------------ | -------------- | ---------- | ------------------------- |
| report_data_record | å˜åŒ–ä¸ŠæŠ¥çš„å†å²å€¼     | data_format_st | å¯¹æ¯”æ•°æ®æ˜¯å¦å˜åŒ–   | publish_type_change()     |
| report_data_rt     | å®æ—¶æ•°æ®æœ€æ–°å€¼      | data_format_st | å®æ—¶æŸ¥è¯¢/å¿«é€Ÿä¸ŠæŠ¥  | publish_type_rt()         |
| report_data        | å¾…ä¸ŠæŠ¥åŸå§‹æ•°æ®      | data_format_st | ç´¯ç§¯æ•°æ®ç­‰å¾…æ‰“åŒ…   | publish_type_xxx()        |
| report_list        | å‘¨æœŸä¸ŠæŠ¥Â JSON æ¶ˆæ¯ | JSON å­—ç¬¦ä¸²       | ç­‰å¾…å‘é€åˆ° MQTT | report_interval_message() |
| report_rt_list     | å®æ—¶ä¸ŠæŠ¥ JSON æ¶ˆæ¯ | JSON å­—ç¬¦ä¸²       | ç­‰å¾…å‘é€åˆ° MQTT | report_rt_message()       |
| alarm_list         | å‘Šè­¦æ•°æ®         | data_format_st | ä¼˜å…ˆå‘é€å‘Šè­¦     | report_alarm_message()    |
